# mluckydwyer/hw-ci Docker Container
FROM mluckydwyer/hw-ci:slim as slim

LABEL \
    org.opencontainers.image.title="Hardware Verification CI Docker container" \
    org.opencontainers.image.description="Modelsim, Verilator, GHDL, VUnit, CocoTB, and Pytest for HW Development (+VNC)." \
    org.opencontainers.image.authors="Matthew Dwyer <dwyer@iastate.edu>" \
    org.opencontainers.image.source="https://github.com/Mluckydwyer/hw-ci"

ENV container docker


# Patch CocoTB-test simulation.py with custom implementation for Modelsim complilation
# RUN rm /opt/Python-3.6.14/lib/python3.6/site-packages/cocotb_test/simulator.py
# COPY resources/simulator.py /opt/Python-3.6.14/lib/python3.6/site-packages/cocotb_test/simulator.py
# EXPOSE 5678

# Install VUnit
FROM slim as vunit
RUN pip3 install vunit_hdl


# Install Modelsim
FROM vunit as modelsim
RUN yum install -y libiodbc unixODBC ncurses ncurses-libs \
    zeromq-devel libXext alsa-lib libXtst libXft libxml2 libedit libX11 libXi \
    glibc glibc.i686 glibc-devel.i386 libgcc.i686 libstdc++-devel.i686 libstdc++ \
    libstdc++.i686 libXext libXext.i686 libXft libXft.i686 libXrender libXtst
WORKDIR /tmp
RUN curl -sS -O https://download.altera.com/akdlm/software/acdsinst/20.1std.1/720/ib_installers/ModelSimSetup-20.1.1.720-linux.run \
    && chmod +x ModelSimSetup-20.1.1.720-linux.run \
    && ./ModelSimSetup-20.1.1.720-linux.run --mode unattended --installdir /opt/intelFPGA/20.1 --accept_eula 1 --modelsim_edition modelsim_ase \
    && rm ModelSimSetup-20.1.1.720-linux.run
ENV PATH="/opt/intelFPGA/20.1/modelsim_ase/bin:${PATH}"


# Install Symbiflow toolchain
FROM modelsim as symbiflow
ENV SYMBIFLOW_INSTALL_DIR=/opt/symbiflow
ENV PATH=$SYMBIFLOW_INSTALL_DIR/xc7/:$PATH
WORKDIR /workspaces/
RUN mkdir -p $SYMBIFLOW_INSTALL_DIR/{xc7,eos-s3}/install \
    && yum -y install git which xz \
    && curl -sSL https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh -o /tmp/Miniconda3-latest-Linux-x86_64.sh \
    && sh /tmp/Miniconda3-latest-Linux-x86_64.sh -u -b -p ${SYMBIFLOW_INSTALL_DIR}/conda \
    && git clone https://github.com/SymbiFlow/symbiflow-examples \
    && cd symbiflow-examples \
    && source "${SYMBIFLOW_INSTALL_DIR}/conda/etc/profile.d/conda.sh" \
    && conda env create -f xc7/environment.yml \
    && conda env create -f eos-s3/environment.yml \
    && rm /tmp/Miniconda3-latest-Linux-x86_64.sh

FROM symbiflow as final
COPY ./resources/*symbiflow*.sh /workspaces/tools
RUN chmod +x /workspaces/tools/*.sh \
    && chmod +rw /root/ -R
WORKDIR /workspaces/


